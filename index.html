<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroBet - Apostas Esportivas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; background-color: #f8f8f8; }
        .title-font { font-family: 'Bebas Neue', cursive; }
        
        .gradient-btn {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            transition: all 0.3s ease;
        }
        .gradient-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 0.4);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 0;
            padding-bottom: 0;
        }
        .accordion-content.open {
            max-height: 500px; /* Altura suficiente para o conteúdo */
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-green-800 text-white py-4 shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div><h1 class="title-font text-4xl">AGROBET</h1><p class="text-sm">Apostas Esportivas</p></div>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="text-right hidden"><p class="font-bold text-lg">Olá, <span id="user-name-display"></span>!</p></div>
                <button id="logout-btn" class="hidden bg-red-600 text-white px-3 py-1 rounded-full text-xs font-bold hover:bg-red-700 transition">Sair</button>
                <button id="my-bets-btn" class="bg-white text-green-800 px-4 py-2 rounded-full font-bold flex items-center hover:bg-gray-200 transition"><i class="fas fa-receipt mr-2"></i>Minhas Apostas</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <section id="open-games-section">
            <h2 class="title-font text-3xl md:text-4xl text-green-800 mb-8 text-center">JOGOS DISPONÍVEIS PARA APOSTAR</h2>
            <div class="space-y-8" id="games-container"></div>
        </section>
        <section id="results-section" class="mt-16">
            <h2 class="title-font text-3xl md:text-4xl text-gray-700 mb-8 text-center">RESULTADOS ANTERIOORES</h2>
            <div class="space-y-4" id="results-container"></div>
        </section>
    </main>

    <!-- Modals -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4">
            <h3 id="login-title" class="title-font text-2xl text-center mb-4 text-green-800">Login</h3>
            <div class="space-y-4">
                <div id="name-field" style="display: none;"><input type="text" id="user-name-input" placeholder="Seu Nome Completo" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"></div>
                <input type="text" id="user-pix-input" placeholder="Sua Chave PIX" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                <input type="password" id="user-password-input" placeholder="Sua Senha" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
            </div>
            <p id="login-error" class="text-red-500 text-sm text-center mt-2 h-4"></p>
            <button id="action-btn" class="w-full mt-4 py-3 gradient-btn text-white font-bold rounded-md">Entrar</button>
            <p class="text-center text-sm mt-4"><a href="#" id="switch-mode-link" class="text-green-600 hover:underline">Não tem uma conta? Registe-se</a></p>
        </div>
    </div>
    <div id="my-bets-modal" class="fixed hidden inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto"><div class="flex justify-between items-center mb-4"><h3 class="title-font text-2xl text-green-800">Minhas Apostas Confirmadas</h3><button id="close-my-bets" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div id="my-bets-list" class="space-y-3"></div></div>
    </div>
    <div id="loading-modal" class="fixed hidden inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-800 mx-auto mb-4"></div><p class="text-lg font-semibold">A processar...</p></div>
    </div>

    <script>
        const SERVER_URL = 'https://agrobets.onrender.com';
        let currentUser = null;
        let isRegisterMode = false;
        let allGames = [];

        // --- Variáveis de elementos do DOM (serão inicializadas após o carregamento da página) ---
        let gamesContainer, resultsContainer, loginModal, myBetsModal, loadingModal, actionBtn, switchModeLink, pixInput, nameInput, passwordInput, nameField, loginError, loginTitle, logoutBtn, myBetsBtn, closeMyBetsBtn;
        
        // --- GERADORES DE HTML ---
        function createGameCardHTML(game) {
            return `
            <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                <div class="p-4 bg-gray-50 border-b">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm bg-gray-200 text-gray-800 font-bold px-3 py-1 rounded-full">${game.date}</div>
                        <p class="text-sm text-gray-600 font-semibold">${game.competition}</p>
                    </div>
                    <div class="flex justify-around items-center text-center">
                        <div class="w-1/3"><img src="${game.home.logo}" class="h-20 mx-auto mb-2"><span class="font-bold text-lg">${game.home.name}</span></div>
                        <div class="text-4xl font-bold text-gray-400 title-font">VS</div>
                        <div class="w-1/3"><img src="${game.away.logo}" class="h-20 mx-auto mb-2"><span class="font-bold text-lg">${game.away.name}</span></div>
                    </div>
                </div>
                <div class="p-2 space-y-2 bg-gray-50">
                    ${createAccordionItemHTML('vitoria', 'Apostar no Vencedor', game)}
                    ${createAccordionItemHTML('placar', 'Apostar no Placar Exato', game)}
                    ${createAccordionItemHTML('melhor_jogador', 'Apostar no Melhor Jogador', game)}
                </div>
            </div>`;
        }

        function createAccordionItemHTML(type, title, game) {
            let content = '';
            const isDisabled = type === 'melhor_jogador' && (!game.players || game.players.length === 0);
            
            switch (type) {
                case 'vitoria':
                    content = `<div class="grid grid-cols-3 gap-2">${['home', 'empate', 'away'].map(opt => `<button data-choice="${opt === 'empate' ? 'empate' : game[opt].name}" class="border rounded p-2 hover:bg-gray-200">${opt === 'empate' ? 'EMPATE' : game[opt].name}</button>`).join('')}</div>`;
                    break;
                case 'placar':
                    content = `<div class="flex items-center justify-center gap-4"><span class="font-bold">${game.home.name}</span><input type="number" min="0" class="w-16 text-center border rounded p-1 score-home" placeholder="0"><span>X</span><input type="number" min="0" class="w-16 text-center border rounded p-1 score-away" placeholder="0"><span class="font-bold">${game.away.name}</span></div>`;
                    break;
                case 'melhor_jogador':
                    content = `<select class="w-full border rounded p-2 player-select"><option value="">Selecione um jogador...</option>${game.players.map(p => `<option value="${p}">${p}</option>`).join('')}</select>`;
                    break;
            }

            return `
            <div class="border rounded-md bg-white">
                <button class="accordion-header w-full flex justify-between items-center p-3 text-left font-bold ${isDisabled ? 'text-gray-400 cursor-not-allowed' : 'text-gray-700'}" data-type="${type}" data-game-id="${game._id}" ${isDisabled ? 'disabled' : ''}>
                    <span>${title}</span>
                    <i class="fas fa-chevron-down transition-transform"></i>
                </button>
                <div class="accordion-content px-4">
                    <div class="space-y-4">
                        ${content}
                        <div class="pt-4 border-t">
                            <label class="font-bold text-center block mb-2">VALOR DA APOSTA:</label>
                            <input type="number" min="1" class="w-full border rounded p-2 text-center text-lg bet-value-input" placeholder="Digite o valor (ex: 10)">
                        </div>
                        <button class="w-full gradient-btn text-white font-bold py-3 rounded-lg text-lg confirm-bet-btn" disabled>APOSTAR</button>
                    </div>
                </div>
            </div>`;
        }

        function createResultCardHTML(game) {
            let winnerText = game.result === 'empate' ? 'Empate' : (game.result === 'home' ? game.home.name : game.away.name);
            const scoreText = game.finalScore ? `${game.finalScore.home} x ${game.finalScore.away}` : 'N/A';
            return `<div class="bg-white p-4 rounded-lg shadow-sm border">
                <div class="flex justify-between items-center"><p class="font-bold text-gray-800">${game.home.name} vs ${game.away.name}</p><p class="text-sm text-gray-500">${game.date}</p></div>
                <div class="mt-3 pt-3 border-t grid grid-cols-1 md:grid-cols-3 text-center">
                    <div><p class="text-sm text-gray-500">Vencedor</p><p class="font-bold text-green-600">${winnerText.toUpperCase()}</p></div>
                    <div><p class="text-sm text-gray-500">Placar Final</p><p class="font-bold">${scoreText}</p></div>
                    <div><p class="text-sm text-gray-500">Melhor Jogador</p><p class="font-bold">${game.bestPlayerResult || 'N/A'}</p></div>
                </div>
            </div>`;
        }
        
        // --- FUNÇÕES DE EVENTOS E AÇÕES ---
        async function loadOpenGames() {
            try {
                const response = await fetch(`${SERVER_URL}/games`);
                const games = await response.json();
                allGames = games;
                gamesContainer.innerHTML = games.length === 0 ? '<p class="text-center text-gray-500">Nenhum jogo aberto para apostas no momento.</p>' : '';
                games.forEach(game => gamesContainer.innerHTML += createGameCardHTML(game));
                initGameCardEventListeners();
            } catch (error) {
                console.error("Erro ao carregar jogos:", error);
                gamesContainer.innerHTML = '<p class="text-center text-red-500">Não foi possível carregar os jogos.</p>';
            }
        }

        async function loadResults() {
            try {
                const response = await fetch(`${SERVER_URL}/results`);
                const results = await response.json();
                resultsContainer.innerHTML = results.length === 0 ? '<p class="text-center text-gray-500">Ainda não há resultados de jogos anteriores.</p>' : '';
                results.forEach(game => resultsContainer.innerHTML += createResultCardHTML(game));
            } catch (error) {
                console.error("Erro ao carregar resultados:", error);
                resultsContainer.innerHTML = '<p class="text-center text-red-500">Não foi possível carregar os resultados.</p>';
            }
        }

        function initGameCardEventListeners() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('i');
                    const isOpen = content.classList.contains('open');
                    
                    const gameCard = header.closest('.bg-white.rounded-lg.shadow-lg');
                    gameCard.querySelectorAll('.accordion-content.open').forEach(openContent => {
                        if (openContent !== content) {
                            openContent.classList.remove('open');
                            openContent.previousElementSibling.querySelector('i').classList.remove('rotate-180');
                        }
                    });

                    content.classList.toggle('open');
                    icon.classList.toggle('rotate-180');
                });
            });

            document.querySelectorAll('.bg-white.rounded-lg.shadow-lg').forEach(card => {
                card.addEventListener('input', () => validateBet(card));
                card.addEventListener('change', () => validateBet(card)); 
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.accordion-content')) {
                        const container = e.target.closest('.accordion-content');
                         if (container.previousElementSibling.dataset.type === 'vitoria') {
                            container.querySelectorAll('button[data-choice]').forEach(b => b.classList.remove('bg-green-200', 'text-white'));
                            if (e.target.tagName === 'BUTTON' && e.target.dataset.choice) {
                                e.target.classList.add('bg-green-200', 'text-white');
                            }
                         }
                    }
                    validateBet(card);
                });
            });
        }
        
        function validateBet(card) {
            card.querySelectorAll('.accordion-content').forEach(content => {
                const confirmBtn = content.querySelector('.confirm-bet-btn');
                const betValue = content.querySelector('.bet-value-input').value;
                const type = content.previousElementSibling.dataset.type;
                let choiceMade = false;
                
                if (type === 'vitoria') choiceMade = !!content.querySelector('button.bg-green-200');
                if (type === 'placar') { const h = content.querySelector('.score-home').value; const a = content.querySelector('.score-away').value; choiceMade = h !== '' && a !== ''; }
                if (type === 'melhor_jogador') choiceMade = !!content.querySelector('.player-select').value;
                
                confirmBtn.disabled = !(choiceMade && betValue && Number(betValue) > 0);
                if (!confirmBtn.disabled) {
                    confirmBtn.onclick = () => handleBet(content);
                }
            });
        }

        async function handleBet(contentElement) {
            const header = contentElement.previousElementSibling;
            const gameId = header.dataset.gameId;
            const betType = header.dataset.type;
            const betValue = contentElement.querySelector('.bet-value-input').value;
            let betChoice = '';

            if (betType === 'vitoria') betChoice = contentElement.querySelector('button.bg-green-200').dataset.choice;
            if (betType === 'placar') betChoice = `${contentElement.querySelector('.score-home').value}x${contentElement.querySelector('.score-away').value}`;
            if (betType === 'melhor_jogador') betChoice = contentElement.querySelector('.player-select').value;
            
            loadingModal.classList.remove('hidden');
            const betData = { gameId, betType, betChoice, unit_price: betValue, user: currentUser };
            try {
                const response = await fetch(`${SERVER_URL}/criar-pagamento`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(betData) });
                if (!response.ok) { const err = await response.json(); throw new Error(err.message || 'Erro do servidor.'); }
                const data = await response.json();
                window.location.href = data.init_point;
            } catch (error) {
                loadingModal.classList.add('hidden');
                alert(`Não foi possível iniciar o pagamento: ${error.message}.`);
            }
        }
        
        async function handleAuthAction() {
            const pix = pixInput.value.trim();
            const password = passwordInput.value.trim();
            const name = nameInput.value.trim();
            showError('');
            if (!pix || !password || (isRegisterMode && !name)) { return showError("Por favor, preencha todos os campos."); }

            loadingModal.querySelector('p').textContent = 'A processar...';
            loadingModal.classList.remove('hidden');

            const url = isRegisterMode ? `${SERVER_URL}/register` : `${SERVER_URL}/login`;
            const body = isRegisterMode ? { name, pix, password } : { pix, password };

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                const data = await response.json();
                if (data.success) { loginSuccess(data.user); } 
                else { showError(data.message || 'Ocorreu um erro.'); }
            } catch (err) { showError("Erro de comunicação com o servidor."); } 
            finally { loadingModal.classList.add('hidden'); }
        }
        
        function loginSuccess(user) {
            currentUser = user;
            localStorage.setItem('agrobetUser', JSON.stringify(currentUser));
            document.getElementById('user-name-display').textContent = currentUser.name.split(' ')[0];
            document.getElementById('user-info').classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            loginModal.style.display = 'none';
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('agrobetUser');
            document.getElementById('user-info').classList.add('hidden');
            logoutBtn.classList.add('hidden');
            loginModal.style.display = 'flex';
        }

        function showError(message) { loginError.textContent = message; }

        function checkStoredUser() {
            const storedUser = localStorage.getItem('agrobetUser');
            if (storedUser) {
                loginSuccess(JSON.parse(storedUser));
            } else {
                loginModal.style.display = 'flex';
            }
        }
        
        async function displayMyBets() {
            if (!currentUser) return;
            const listElement = document.getElementById('my-bets-list');
            listElement.innerHTML = '<p class="text-gray-500">A carregar apostas...</p>';
            myBetsModal.classList.remove('hidden');
            try {
                const response = await fetch(`${SERVER_URL}/my-bets/${currentUser.pix}`);
                const data = await response.json();
                if (data.success) {
                    if (data.bets.length === 0) {
                        listElement.innerHTML = '<p class="text-gray-500">Ainda não tem nenhuma aposta confirmada.</p>';
                        return;
                    }
                    listElement.innerHTML = data.bets.map(bet => {
                        return `<div class="border rounded-md p-3 bg-gray-50">
                            <p class="font-bold">${bet.gameTitle}</p>
                            <p>Tipo: ${bet.betType} | Palpite: ${bet.betChoice} - <span class="font-bold text-green-600">R$ ${Number(bet.betValue).toFixed(2)}</span></p>
                            <p class="text-sm text-gray-500">${new Date(bet.date).toLocaleString('pt-BR')}</p>
                        </div>`;
                    }).join('');
                } else {
                    listElement.innerHTML = `<p class="text-red-500">${data.message}</p>`;
                }
            } catch (error) {
                listElement.innerHTML = '<p class="text-red-500">Não foi possível carregar as suas apostas.</p>';
            }
        }

        function toggleMode() {
            isRegisterMode = !isRegisterMode;
            showError('');
            loginTitle.textContent = isRegisterMode ? 'Registo' : 'Login';
            actionBtn.textContent = isRegisterMode ? 'Registar' : 'Entrar';
            switchModeLink.textContent = isRegisterMode ? 'Já tem uma conta? Entre' : 'Não tem uma conta? Registe-se';
            nameField.style.display = isRegisterMode ? 'block' : 'none';
        }
        
        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar elementos do DOM
            gamesContainer = document.getElementById('games-container');
            resultsContainer = document.getElementById('results-container');
            loginModal = document.getElementById('login-modal');
            myBetsModal = document.getElementById('my-bets-modal');
            loadingModal = document.getElementById('loading-modal');
            actionBtn = document.getElementById('action-btn');
            switchModeLink = document.getElementById('switch-mode-link');
            pixInput = document.getElementById('user-pix-input');
            nameInput = document.getElementById('user-name-input');
            passwordInput = document.getElementById('user-password-input');
            nameField = document.getElementById('name-field');
            loginError = document.getElementById('login-error');
            loginTitle = document.getElementById('login-title');
            logoutBtn = document.getElementById('logout-btn');
            myBetsBtn = document.getElementById('my-bets-btn');
            closeMyBetsBtn = document.getElementById('close-my-bets');

            // Adicionar event listeners principais
            actionBtn.addEventListener('click', handleAuthAction);
            switchModeLink.addEventListener('click', (e) => { e.preventDefault(); toggleMode(); });
            logoutBtn.addEventListener('click', logout);
            myBetsBtn.addEventListener('click', displayMyBets);
            closeMyBetsBtn.addEventListener('click', () => myBetsModal.classList.add('hidden'));

            // Carregar dados iniciais
            loadOpenGames();
            loadResults();
            checkStoredUser();
        });
    </script>
</body>
</html>

