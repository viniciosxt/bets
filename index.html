<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroBet - Apostas Esportivas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;700&display=swap');
        body { font-family: 'Montserrat', sans-serif; background-color: #f8f8f8; padding-bottom: 200px; /* Espaço para o boletim */ }
        .title-font { font-family: 'Bebas Neue', cursive; }
        .bet-option.selected { background-color: #1b5e20; color: white; border-color: #1b5e20; }
        .confirm-btn { background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); transition: all 0.3s ease; }
        .confirm-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 125, 0.4); }
        /* Estilos para o Boletim de Apostas */
        #bet-slip { transition: transform 0.3s ease-in-out; }
        #bet-slip.hidden { transform: translateY(100%); }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-green-800 text-white py-4 shadow-md sticky top-0 z-40">
        <!-- ... (código do header existente sem alterações) ... -->
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <section id="open-games-section">
            <h2 class="title-font text-3xl md:text-4xl text-green-800 mb-8 text-center">JOGOS DISPONÍVEIS</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="games-container"></div>
        </section>
        <!-- ... (secção de resultados existente) ... -->
    </main>
    
    <!-- NOVO: Boletim de Apostas (Prioridade 2) -->
    <div id="bet-slip" class="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-green-800 shadow-2xl p-4 z-50 hidden">
        <div class="container mx-auto">
            <div class="flex justify-between items-center mb-2">
                <h3 class="title-font text-2xl text-green-800">BOLETIM DE APOSTAS</h3>
                <button id="clear-slip-btn" class="text-red-500 hover:text-red-700 text-sm font-bold">Limpar Tudo</button>
            </div>
            <div id="slip-items-container" class="space-y-2 max-h-40 overflow-y-auto mb-4">
                <!-- As seleções de aposta aparecerão aqui -->
            </div>
            <div id="slip-summary" class="hidden">
                <div class="flex justify-between items-center font-bold text-lg">
                    <span>Total de Odds:</span>
                    <span id="total-odds-display">1.00</span>
                </div>
                <div class="mt-2">
                    <input type="number" id="slip-value-input" class="w-full p-2 border rounded text-center" min="1" step="any" placeholder="Valor da Aposta (R$)">
                </div>
                <div class="text-center font-bold my-2 text-lg">
                    Retorno Potencial: <span id="slip-potential-payout" class="text-green-700">R$ 0.00</span>
                </div>
                <div id="slip-error" class="text-red-500 text-sm text-center h-4 mb-2"></div>
                <button id="place-bet-btn" class="w-full py-3 confirm-btn text-white font-bold text-lg rounded-md" disabled>FINALIZAR APOSTA</button>
            </div>
        </div>
    </div>

    <!-- Modals (existentes) -->
    <!-- ... (código dos modals existentes sem alterações) ... -->

    <script>
        const SERVER_URL = 'https://agrobets.onrender.com';
        let currentUser = null;
        let allGames = [];
        let betSlip = []; // Estado global para o boletim de apostas

        // --- ELEMENTOS DO DOM ---
        const gamesContainer = document.getElementById('games-container');
        const betSlipContainer = document.getElementById('bet-slip');
        const slipItemsContainer = document.getElementById('slip-items-container');
        const slipSummary = document.getElementById('slip-summary');
        const totalOddsDisplay = document.getElementById('total-odds-display');
        const slipValueInput = document.getElementById('slip-value-input');
        const slipPotentialPayout = document.getElementById('slip-potential-payout');
        const placeBetBtn = document.getElementById('place-bet-btn');
        const clearSlipBtn = document.getElementById('clear-slip-btn');
        const slipError = document.getElementById('slip-error');
        
        // --- FUNÇÕES PRINCIPAIS ---
        async function loadOpenGames() {
            try {
                // ... (lógica de fetch existente)
                const response = await fetch(`${SERVER_URL}/games`);
                const games = await response.json();
                allGames = games;
                gamesContainer.innerHTML = games.length === 0 ? '<p class="text-center text-gray-500 col-span-2">Nenhum jogo aberto para apostas.</p>' : '';
                
                games.forEach(game => {
                    // PRIORIDADE 1: HTML para os novos mercados
                    gamesContainer.innerHTML += `
                    <div class="bet-card bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden" data-game-id="${game._id}">
                        <div class="bg-green-800 text-white py-2 px-4 flex justify-between items-center"><h3 class="title-font text-xl">${game.competition}</h3><div class="text-sm bg-white text-green-800 font-bold px-3 py-1 rounded-full">${game.date}</div></div>
                        <div class="p-6">
                            <div class="flex justify-around items-center mb-6"><!-- ... info dos times ... --></div>
                            
                            <!-- Mercado: Resultado Final -->
                            <div class="mb-4">
                                <h4 class="font-bold mb-2 text-center text-gray-700">RESULTADO FINAL</h4>
                                <div class="grid grid-cols-3 gap-2">
                                    <button class="bet-option py-2 border rounded flex flex-col items-center" data-type="RESULTADO_FINAL" data-choice="home" data-odd="${game.odds.home}"><span>${game.home.name}</span><span class="font-bold text-green-600">${game.odds.home.toFixed(2)}</span></button>
                                    <button class="bet-option py-2 border rounded flex flex-col items-center" data-type="RESULTADO_FINAL" data-choice="draw" data-odd="${game.odds.draw}"><span>EMPATE</span><span class="font-bold text-green-600">${game.odds.draw.toFixed(2)}</span></button>
                                    <button class="bet-option py-2 border rounded flex flex-col items-center" data-type="RESULTADO_FINAL" data-choice="away" data-odd="${game.odds.away}"><span>${game.away.name}</span><span class="font-bold text-green-600">${game.odds.away.toFixed(2)}</span></button>
                                </div>
                            </div>
                            
                            <!-- Mercado: Total de Golos -->
                            <div class="mb-4">
                                <h4 class="font-bold mb-2 text-center text-gray-700">TOTAL DE GOLOS (MAIS/MENOS 2.5)</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <button class="bet-option py-2 border rounded flex flex-col items-center" data-type="GOLOS_MAIS_2_5" data-choice="sim" data-odd="${game.odds.over25}"><span>MAIS DE 2.5</span><span class="font-bold text-green-600">${game.odds.over25.toFixed(2)}</span></button>
                                    <button class="bet-option py-2 border rounded flex flex-col items-center" data-type="GOLOS_MENOS_2_5" data-choice="nao" data-odd="${game.odds.under25}"><span>MENOS DE 2.5</span><span class="font-bold text-green-600">${game.odds.under25.toFixed(2)}</span></button>
                                </div>
                            </div>

                            <!-- Mercado: Ambas Marcam -->
                            <div class="mb-4">
                                <h4 class="font-bold mb-2 text-center text-gray-700">AMBAS AS EQUIPAS MARCAM</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <button class="bet-option py-2 border rounded flex flex-col items-center" data-type="AMBAS_MARCAM" data-choice="sim" data-odd="${game.odds.btsYes}"><span>SIM</span><span class="font-bold text-green-600">${game.odds.btsYes.toFixed(2)}</span></button>
                                    <button class="bet-option py-2 border rounded flex flex-col items-center" data-type="AMBAS_MARCAM" data-choice="nao" data-odd="${game.odds.btsNo}"><span>NÃO</span><span class="font-bold text-green-600">${game.odds.btsNo.toFixed(2)}</span></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                addGameEventListeners();
            } catch (error) { /* ... (tratamento de erro) ... */ }
        }

        // --- LÓGICA DO BOLETIM DE APOSTAS (Prioridade 2) ---
        function addGameEventListeners() {
            document.querySelectorAll('.bet-option').forEach(button => {
                button.addEventListener('click', () => {
                    const card = button.closest('.bet-card');
                    const gameId = card.dataset.gameId;
                    const game = allGames.find(g => g._id === gameId);

                    const selection = {
                        gameId: gameId,
                        gameTitle: `${game.home.name} vs ${game.away.name}`,
                        betType: button.dataset.type,
                        betChoice: button.querySelector('span:first-child').textContent,
                        betChoiceKey: button.dataset.choice,
                        odds: parseFloat(button.dataset.odd),
                        id: `${gameId}-${button.dataset.type}` // ID único para a seleção
                    };
                    addToBetSlip(selection);
                });
            });
        }

        function addToBetSlip(selection) {
            // Impede adicionar o mesmo mercado do mesmo jogo
            const existingSelectionIndex = betSlip.findIndex(item => item.id === selection.id);
            if (existingSelectionIndex > -1) {
                betSlip.splice(existingSelectionIndex, 1); // Remove se já existe (efeito de toggle)
            }
            
            // Impede adicionar mercados diferentes do mesmo jogo (regra de negócio comum)
            const sameGameSelection = betSlip.find(item => item.gameId === selection.gameId);
            if(sameGameSelection) {
                 alert("Não pode adicionar duas apostas do mesmo jogo numa aposta múltipla.");
                 return;
            }

            betSlip.push(selection);
            renderBetSlip();
        }

        function removeFromBetSlip(selectionId) {
            betSlip = betSlip.filter(item => item.id !== selectionId);
            renderBetSlip();
        }


        function renderBetSlip() {
            // Atualiza os botões selecionados na lista de jogos
            document.querySelectorAll('.bet-option.selected').forEach(btn => btn.classList.remove('selected'));
            betSlip.forEach(sel => {
                const btn = document.querySelector(`[data-game-id="${sel.gameId}"] [data-type="${sel.betType}"]`);
                if(btn) btn.classList.add('selected');
            });

            if (betSlip.length === 0) {
                betSlipContainer.classList.add('hidden');
                return;
            }

            betSlipContainer.classList.remove('hidden');
            slipItemsContainer.innerHTML = betSlip.map(item => `
                <div class="bg-gray-100 p-2 rounded flex justify-between items-center">
                    <div>
                        <p class="text-sm font-bold">${item.betChoice}</p>
                        <p class="text-xs text-gray-600">${item.gameTitle}</p>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold mr-4">${item.odds.toFixed(2)}</span>
                        <button class="remove-item-btn text-red-500 hover:text-red-700" data-id="${item.id}">&times;</button>
                    </div>
                </div>
            `).join('');

            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', () => removeFromBetSlip(button.dataset.id));
            });

            const totalOdds = betSlip.reduce((acc, item) => acc * item.odds, 1);
            totalOddsDisplay.textContent = totalOdds.toFixed(2);
            slipSummary.classList.remove('hidden');
            updateSlipPayout();
        }
        
        function updateSlipPayout() {
            const value = parseFloat(slipValueInput.value) || 0;
            const totalOdds = parseFloat(totalOddsDisplay.textContent);
            const payout = value * totalOdds;
            slipPotentialPayout.textContent = `R$ ${payout.toFixed(2)}`;
            placeBetBtn.disabled = !(value > 0 && betSlip.length > 0);
        }

        async function placeBet() {
            slipError.textContent = '';
            if (!currentUser) {
                alert("Por favor, faça login para poder apostar.");
                loginModal.style.display = 'flex';
                return;
            }
            const value = parseFloat(slipValueInput.value);
            if (!value || value <= 0) {
                slipError.textContent = 'Por favor, insira um valor válido.';
                return;
            }

            const betData = {
                selections: betSlip.map(s => ({ gameId: s.gameId, gameTitle: s.gameTitle, betType: s.betType, betChoice: s.betChoice, odds: s.odds })),
                value: value,
                user: currentUser
            };
            
            // ... (lógica de chamada ao /criar-pagamento similar à antiga, mas com a nova estrutura de dados)
        }
        
        clearSlipBtn.addEventListener('click', () => {
            betSlip = [];
            renderBetSlip();
        });

        slipValueInput.addEventListener('input', updateSlipPayout);
        placeBetBtn.addEventListener('click', placeBet);

        // --- (Restante do script, login, etc., com pequenas adaptações se necessário) ---
        // A função original handleBet() foi substituída pela lógica do boletim.

    </script>
</body>
</html>
